<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pencatat Pengeluaran Harian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="manifest" href="/pengeluaran/manifest.json">
    <meta name="theme-color" content="#0D9488">
    <link rel="apple-touch-icon" href="/pengeluaran/icons/icon-192x192.png">

    <style>
        :root {
            --bg-primary: #F3F4F6;
            --bg-secondary: #E5E7EB;
            --bg-accent: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563; /* Digunakan untuk teks footer juga */
            --header-bg: #0D9488;
            --header-text: #FFFFFF;
            --bubble-user-bg: #DCF8C6;
            --bubble-user-text: #1F2937;
            --bubble-app-bg: #FFFFFF;
            --bubble-app-text: #1F2937;
            --bubble-app-border: #D1D5DB;
            --button-bg: #0D9488;
            --button-text: #FFFFFF;
            --input-border: #9CA3AF;
            --input-focus-ring: #0D9488;
            --loader-top-border: #0D9488;
            --menu-bg: #FFFFFF;
            --menu-text: #1F2937;
            --menu-hover-bg: #F3F4F6;
            --modal-bg: #FFFFFF;
            --modal-text: #1F2937;
            --modal-overlay-bg: rgba(0,0,0,0.5);
            --default-chat-bg-color: #ECE5DD;
            --footer-extra-bg: var(--bg-secondary); /* Sama dengan app-footer */
            --footer-extra-text: var(--text-secondary);
        }

        html.dark {
            --bg-primary: #1F2937;
            --bg-secondary: #374151;
            --bg-accent: #4B5563;
            --text-primary: #F3F4F6;
            --text-secondary: #9CA3AF; /* Sedikit lebih terang untuk dark mode footer */
            --header-bg: #0F766E;
            --header-text: #F3F4F6;
            --bubble-user-bg: #075E54;
            --bubble-user-text: #F3F4F6;
            --bubble-app-bg: #374151;
            --bubble-app-text: #F3F4F6;
            --bubble-app-border: #4B5563;
            --button-bg: #0F766E;
            --button-text: #F3F4F6;
            --input-border: #6B7280;
            --input-focus-ring: #0F766E;
            --loader-top-border: #14B8A6;
            --menu-bg: #374151;
            --menu-text: #F3F4F6;
            --menu-hover-bg: #4B5563;
            --modal-bg: #374151;
            --modal-text: #F3F4F6;
            --modal-overlay-bg: rgba(0,0,0,0.7);
            --default-chat-bg-color: #08313A;
            --footer-extra-bg: var(--bg-secondary);
            --footer-extra-text: var(--text-secondary);
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        html, body { height: 100%; overflow: hidden; }
        .app-container {
            display: flex; flex-direction: column;
            height: 100vh; width: 100vw;
            background-color: var(--bg-secondary);
        }
        .app-header { background-color: var(--header-bg); color: var(--header-text); }
        #chat-messages {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        #chat-messages::-webkit-scrollbar-thumb { background-color: var(--text-secondary); }
        #chat-messages { scrollbar-color: var(--text-secondary) var(--bg-secondary); }
        .chat-bubble-container { display: flex; margin-bottom: 8px; }
        .chat-bubble-container.user { justify-content: flex-end; }
        .chat-bubble-container.app { justify-content: flex-start; }
        .chat-bubble {
            max-width: 75%; padding: 10px 14px; border-radius: 20px;
            word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .chat-bubble-user {
            background-color: var(--bubble-user-bg); color: var(--bubble-user-text);
            border-bottom-right-radius: 5px;
        }
        .chat-bubble-app {
            background-color: var(--bubble-app-bg); color: var(--bubble-app-text);
            border: 1px solid var(--bubble-app-border); border-bottom-left-radius: 5px;
        }
        .app-footer { /* Kontainer untuk input pesan */
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--bubble-app-border);
        }
        .app-footer-extra { /* Kontainer untuk jam dan kredit */
            background-color: var(--footer-extra-bg);
            color: var(--footer-extra-text);
            padding: 8px 12px; /* Padding yang sesuai */
            text-align: center;
            font-size: 0.75rem; /* Ukuran font lebih kecil */
            line-height: 1rem;
            border-top: 1px solid var(--bubble-app-border); /* Garis pemisah jika diperlukan */
        }
        #message-input {
            background-color: var(--bg-accent); color: var(--text-primary);
            border: 1px solid var(--input-border);
        }
        #message-input:focus { --tw-ring-color: var(--input-focus-ring); }
        #send-button { background-color: var(--button-bg); color: var(--button-text); }
        #send-button:hover { filter: brightness(110%); }
        .loader {
            border: 4px solid var(--bg-secondary); border-top: 4px solid var(--loader-top-border);
            border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite;
        }
        #full-screen-loader { background-color: var(--modal-overlay-bg); }
        #full-screen-loader p { color: var(--header-text); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none; position: absolute; right: 0;
            background-color: var(--menu-bg);
            min-width: 220px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 100; border-radius: 8px; padding: 8px 0;
        }
        .dropdown-content button {
            color: var(--menu-text); padding: 10px 16px;
            text-decoration: none; display: block; width: 100%;
            text-align: left; background: none; border: none; cursor: pointer;
        }
        .dropdown-content button:hover { background-color: var(--menu-hover-bg); }
        .dropdown:hover .dropdown-content, .dropdown-content.show { display: block; }

        .modal { background-color: var(--modal-overlay-bg); }
        .modal-content { background-color: var(--modal-bg); color: var(--modal-text); }
        .modal-content input[type="url"], .modal-content input[type="text"] {
             background-color: var(--bg-accent); color: var(--text-primary);
             border: 1px solid var(--input-border);
        }
        .color-swatch {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent;
        }
        .color-swatch.selected { border-color: var(--input-focus-ring); }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header p-4 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center">
                 <img src="/pengeluaran/icons/icon-48x48.png" alt="Logo Aplikasi" class="w-10 h-10 mr-3 p-1 bg-white rounded-full">
                <div>
                    <h1 class="text-xl font-semibold">Asisten Keuangan</h1>
                    <p id="user-status" class="text-sm opacity-80">Lokal</p>
                </div>
            </div>
            <div class="dropdown">
                <button id="menu-button" class="p-2 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M10.5 6a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Zm0 6a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Zm0 6a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="dropdown-menu" class="dropdown-content">
                    <button id="dark-mode-toggle">Mode Gelap: Mati</button>
                    <button id="change-background-button">Ubah Background Chat</button>
                    <button id="backup-data">Backup Data</button>
                    <button id="restore-data-button">Restore Data</button>
                    <input type="file" id="restore-data-input" class="hidden" accept=".json">
                </div>
            </div>
        </header>

        <div id="chat-messages" class="flex-1 p-4 space-y-1 overflow-y-auto">
            </div>

        <div id="full-screen-loader" class="fixed inset-0 flex flex-col items-center justify-center z-[100] hidden">
            <div class="loader mb-3"></div>
            <p class="text-lg text-white">Memproses...</p>
        </div>

        <footer class="app-footer p-3 flex-shrink-0">
            <div class="flex items-center">
                <input type="text" id="message-input" class="flex-1 p-3 rounded-full focus:outline-none focus:ring-2 shadow-sm" placeholder="Ketik pengeluaran atau perintah...">
                <button id="send-button" class="ml-3 p-3 rounded-full focus:outline-none focus:ring-2 shadow-md transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
                    </svg>
                </button>
            </div>
        </footer>
        <div class="app-footer-extra flex-shrink-0">
            <div id="clock" class="mb-1">Memuat waktu...</div>
            <div>Made with ❤️ by kopilnux & Gemini AI</div>
        </div>
    </div>

    <div id="background-modal" class="modal fixed inset-0 flex items-center justify-center z-[90] hidden">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Ubah Background Chat</h3>
                <button id="close-modal-button" class="text-2xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div>
                <h4 class="text-md font-medium mb-2">Pilih Warna:</h4>
                <div id="color-palette" class="flex flex-wrap gap-2 mb-4"></div>

                <h4 class="text-md font-medium mb-2">URL Gambar:</h4>
                <input type="url" id="image-url-input" class="w-full p-2 border rounded mb-2" placeholder="https://example.com/image.png">
                <button id="apply-image-url" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded mb-4">Terapkan dari URL</button>

                <h4 class="text-md font-medium mb-2">Unggah Gambar:</h4>
                <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                <button id="trigger-image-upload" class="w-full bg-green-500 hover:bg-green-600 text-white p-2 rounded mb-4">Pilih Gambar dari Perangkat</button>
                
                <button id="reset-background" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded mt-2">Reset ke Default</button>
            </div>
        </div>
    </div>

    <script type="module">
        const chatMessagesContainer = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const fullScreenLoader = document.getElementById('full-screen-loader');
        const clockElement = document.getElementById('clock'); // Element untuk jam

        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const backupDataButton = document.getElementById('backup-data');
        const restoreDataButton = document.getElementById('restore-data-button');
        const restoreDataInput = document.getElementById('restore-data-input');
        const changeBackgroundButton = document.getElementById('change-background-button');

        const backgroundModal = document.getElementById('background-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const colorPaletteContainer = document.getElementById('color-palette');
        const imageUrlInput = document.getElementById('image-url-input');
        const applyImageUrlButton = document.getElementById('apply-image-url');
        const imageUploadInput = document.getElementById('image-upload-input');
        const triggerImageUploadButton = document.getElementById('trigger-image-upload');
        const resetBackgroundButton = document.getElementById('reset-background');

        const APP_DATA_KEY = 'expenseTrackerData_v5_pwa_footer'; // Version up
        let appData = {
            expenses: [],
            darkMode: false,
            chatBackground: { type: 'color', value: getComputedStyle(document.documentElement).getPropertyValue('--default-chat-bg-color').trim(), isDefault: true }
        };

        const PREDEFINED_COLORS = [
            { name: 'Default Green', value: '#ECE5DD', darkValue: '#08313A' },
            { name: 'Light Blue', value: '#E0F2F7', darkValue: '#01579B' },
            { name: 'Light Gray', value: '#F3F4F6', darkValue: '#4B5563' },
            { name: 'White', value: '#FFFFFF', darkValue: '#374151' },
            { name: 'Soft Pink', value: '#FCE4EC', darkValue: '#880E4F' },
            { name: 'Pale Yellow', value: '#FFF9C4', darkValue: '#F57F17' }
        ];

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/pengeluaran/sw.js', { scope: '/pengeluaran/' }) 
                    .then(registration => {
                        console.log('ServiceWorker: Pendaftaran berhasil, scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker: Pendaftaran gagal: ', error);
                    });
            });
        }

        // --- Real-time Clock ---
        function updateClock() {
            const now = new Date();
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const dayName = days[now.getDay()];
            const day = now.getDate().toString().padStart(2, '0');
            const monthName = months[now.getMonth()];
            const year = now.getFullYear();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');

            clockElement.textContent = `${dayName}, ${day} ${monthName} ${year} - ${hours}:${minutes}:${seconds}`;
        }
        setInterval(updateClock, 1000); // Update setiap detik
        updateClock(); // Panggil sekali saat load

        // --- Local Storage ---
        function loadAppData() {
            const data = localStorage.getItem(APP_DATA_KEY);
            if (data) {
                const parsedData = JSON.parse(data);
                appData = { ...appData, ...parsedData };
                appData.expenses = appData.expenses.map(exp => ({ ...exp, timestamp: new Date(exp.timestamp) }));
                if (!appData.chatBackground || typeof appData.chatBackground.isDefault === 'undefined') {
                    appData.chatBackground = { type: 'color', value: getCurrentDefaultBgColor(), isDefault: true };
                }
            }
            document.querySelector('meta[name="theme-color"]').setAttribute('content', appData.darkMode ? '#0F766E' : '#0D9488');
            applyDarkModePreference();
            applyChatBackground();
        }
        function saveAppData() { localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData)); }
        function getCurrentDefaultBgColor() { return getComputedStyle(document.documentElement).getPropertyValue('--default-chat-bg-color').trim(); }

        // --- Dark Mode ---
        function applyDarkModePreference() {
            const isDark = appData.darkMode;
            document.documentElement.classList.toggle('dark', isDark);
            darkModeToggle.textContent = `Mode Gelap: ${isDark ? 'Aktif' : 'Mati'}`;
            document.querySelector('meta[name="theme-color"]').setAttribute('content', isDark ? '#0F766E' : '#0D9488');
            if (appData.chatBackground.isDefault) {
                 appData.chatBackground = { type: 'color', value: getCurrentDefaultBgColor(), isDefault: true };
                 applyChatBackground();
            }
            populateColorPalette();
        }
        darkModeToggle.addEventListener('click', () => {
            appData.darkMode = !appData.darkMode;
            applyDarkModePreference();
            saveAppData();
            closeMenu();
        });

        // --- Chat Background ---
        function applyChatBackground() {
            const bg = appData.chatBackground;
            if (bg.type === 'color') {
                chatMessagesContainer.style.backgroundColor = bg.value;
                chatMessagesContainer.style.backgroundImage = 'none';
            } else if (bg.type === 'image_url' || bg.type === 'image_upload') {
                if (bg.value && (bg.value.startsWith('http') || bg.value.startsWith('data:image'))) {
                    chatMessagesContainer.style.backgroundImage = `url('${bg.value}')`;
                    chatMessagesContainer.style.backgroundColor = 'transparent';
                } else {
                     displayMessage('URL/Data gambar tidak valid. Kembali ke default.', 'app');
                     resetChatBackgroundToDefault();
                }
            }
        }
        function resetChatBackgroundToDefault() {
            appData.chatBackground = { type: 'color', value: getCurrentDefaultBgColor(), isDefault: true };
            applyChatBackground();
            saveAppData();
        }
        changeBackgroundButton.addEventListener('click', () => {
            populateColorPalette();
            imageUrlInput.value = (appData.chatBackground.type === 'image_url') ? appData.chatBackground.value : '';
            backgroundModal.classList.remove('hidden');
            closeMenu();
        });
        closeModalButton.addEventListener('click', () => backgroundModal.classList.add('hidden'));
        backgroundModal.addEventListener('click', (event) => { if (event.target === backgroundModal) backgroundModal.classList.add('hidden'); });

        function populateColorPalette() {
            colorPaletteContainer.innerHTML = '';
            PREDEFINED_COLORS.forEach(color => {
                const swatch = document.createElement('div');
                swatch.classList.add('color-swatch');
                const colorValue = appData.darkMode ? color.darkValue : color.value;
                swatch.style.backgroundColor = colorValue;
                swatch.title = color.name;
                if (appData.chatBackground.type === 'color' && appData.chatBackground.value === colorValue) {
                    swatch.classList.add('selected');
                }
                swatch.addEventListener('click', () => {
                    appData.chatBackground = { type: 'color', value: colorValue, isDefault: (colorValue === getCurrentDefaultBgColor()) };
                    applyChatBackground();
                    saveAppData();
                    document.querySelectorAll('#color-palette .color-swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                });
                colorPaletteContainer.appendChild(swatch);
            });
        }
        applyImageUrlButton.addEventListener('click', () => {
            const url = imageUrlInput.value.trim();
            if (url) {
                appData.chatBackground = { type: 'image_url', value: url, isDefault: false };
                applyChatBackground();
                saveAppData();
            } else { displayMessage('URL gambar tidak boleh kosong.', 'app'); }
        });
        triggerImageUploadButton.addEventListener('click', () => imageUploadInput.click());
        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    appData.chatBackground = { type: 'image_upload', value: e.target.result, isDefault: false };
                    applyChatBackground();
                    saveAppData();
                };
                reader.readAsDataURL(file);
            } else if (file) {
                displayMessage('Harap pilih file gambar (PNG, JPG, GIF, dll).', 'app');
            }
            imageUploadInput.value = '';
        });
        resetBackgroundButton.addEventListener('click', () => { resetChatBackgroundToDefault(); });

        // --- Backup & Restore ---
        backupDataButton.addEventListener('click', () => {
            if (appData.expenses.length === 0 && appData.chatBackground.isDefault && !appData.darkMode) {
                displayMessage('Tidak ada data kustom untuk di-backup.', 'app');
                closeMenu(); return;
            }
            const jsonData = JSON.stringify(appData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const dl_url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = dl_url;
            const today = new Date();
            const dateString = `${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}`;
            a.download = `expenses_backup_${dateString}_v5.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(dl_url);
            displayMessage('Data berhasil di-backup.', 'app'); closeMenu();
        });
        restoreDataInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (restoredData && typeof restoredData.expenses !== 'undefined' && 
                            typeof restoredData.darkMode !== 'undefined' && 
                            typeof restoredData.chatBackground !== 'undefined' &&
                            typeof restoredData.chatBackground.type !== 'undefined' &&
                            typeof restoredData.chatBackground.value !== 'undefined'
                            ) {
                            appData = { ...appData, ...restoredData,
                                expenses: restoredData.expenses.map(exp => ({ ...exp, timestamp: new Date(exp.timestamp) }))
                            };
                            if (typeof appData.chatBackground.isDefault === 'undefined') {
                                appData.chatBackground.isDefault = (appData.chatBackground.type === 'color' && appData.chatBackground.value === getCurrentDefaultBgColor());
                            }
                            saveAppData(); applyDarkModePreference(); applyChatBackground();
                            chatMessagesContainer.innerHTML = ''; // Hapus pesan lama
                            displayMessage('Data berhasil di-restore. Silakan mulai percakapan baru atau minta laporan.', 'app');
                        } else { displayMessage('Format file backup tidak valid atau versi lama. Restore dibatalkan.', 'app'); }
                    } catch (error) { console.error("Error restoring data:", error); displayMessage(`Gagal restore: ${error.message}`, 'app'); }
                };
                reader.readAsText(file); restoreDataInput.value = '';
            }
        });
        restoreDataButton.addEventListener('click', () => { restoreDataInput.click(); closeMenu(); });

        // --- UI Helpers & Core Logic ---
        function displayMessage(text, sender) {
            const messageContainerDiv = document.createElement('div');
            messageContainerDiv.classList.add('chat-bubble-container');
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('chat-bubble');
            if (sender === 'user') {
                messageContainerDiv.classList.add('user');
                bubbleDiv.classList.add('chat-bubble-user');
            } else {
                messageContainerDiv.classList.add('app');
                bubbleDiv.classList.add('chat-bubble-app');
            }
            bubbleDiv.innerHTML = text.replace(/\n/g, '<br>');
            messageContainerDiv.appendChild(bubbleDiv);
            chatMessagesContainer.appendChild(messageContainerDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        function showLoader(show) { fullScreenLoader.classList.toggle('hidden', !show); }
        function closeMenu() { dropdownMenu.classList.remove('show');}
        menuButton.addEventListener('click', (event) => { event.stopPropagation(); dropdownMenu.classList.toggle('show'); });
        document.addEventListener('click', (event) => { if (!menuButton.contains(event.target) && !dropdownMenu.contains(event.target)) closeMenu(); });
        function generateId() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; const numbers = '0123456789'; let idChars = [];
            for (let i = 0; i < 2; i++) { idChars.push(letters.charAt(Math.floor(Math.random() * letters.length))); idChars.push(numbers.charAt(Math.floor(Math.random() * numbers.length))); }
            for (let i = idChars.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [idChars[i], idChars[j]] = [idChars[j], idChars[i]]; }
            return idChars.join('');
        }
        function recordExpense(item, amount) { const newExpense = { id: generateId(), item, amount, timestamp: new Date() }; appData.expenses.push(newExpense); saveAppData(); const formattedAmount = amount.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }); displayMessage(`Pengeluaran: <strong>${item}</strong> (${formattedAmount}) tercatat. ID: <strong>${newExpense.id}</strong>.`, 'app'); }
        function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return "Tgl invalid"; const d = date.getDate().toString().padStart(2, '0'); const m = (date.getMonth() + 1).toString().padStart(2, '0'); const y = date.getFullYear(); return `${d}/${m}/${y}`; }
        function formatDateShort(date) { if (!(date instanceof Date) || isNaN(date)) return "Tgl invalid"; const d = date.getDate().toString().padStart(2, '0'); const m = (date.getMonth() + 1).toString().padStart(2, '0'); return `${d}/${m}`; }
        function generateDailyReport() { const today = new Date(); const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0,0,0,0); const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23,59,59,999); const dailyExpenses = appData.expenses.filter(exp => exp.timestamp >= startOfDay && exp.timestamp <= endOfDay).sort((a,b) => a.timestamp - b.timestamp); let reportMessage = `<strong>Laporan Hari Ini (${formatDate(today)}):</strong>\n`; let totalExpenses = 0; if (dailyExpenses.length === 0) { reportMessage += "\nBelum ada pengeluaran hari ini."; } else { dailyExpenses.forEach(data => { const formattedAmount = data.amount.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }); reportMessage += `\n- ${data.item}: ${formattedAmount} (ID: ${data.id})`; totalExpenses += data.amount; }); const formattedTotal = totalExpenses.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }); reportMessage += `\n\n<strong>Total Hari Ini: ${formattedTotal}</strong>`; } displayMessage(reportMessage, 'app'); }
        function generateMonthlyReport() { const today = new Date(); const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1,0,0,0,0); const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23,59,59,999); const monthlyExpenses = appData.expenses.filter(exp => exp.timestamp >= startOfMonth && exp.timestamp <= endOfMonth).sort((a,b) => a.timestamp - b.timestamp); const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"]; let reportMessage = `<strong>Laporan Bulan ${monthNames[today.getMonth()]} ${today.getFullYear()}:</strong>\n`; let totalExpenses = 0; if (monthlyExpenses.length === 0) { reportMessage += "\nBelum ada pengeluaran bulan ini."; } else { monthlyExpenses.forEach(data => { const formattedAmount = data.amount.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }); reportMessage += `\n- (${formatDateShort(data.timestamp)}) ${data.item}: ${formattedAmount} (ID: ${data.id})`; totalExpenses += data.amount; }); const formattedTotal = totalExpenses.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }); reportMessage += `\n\n<strong>Total Bulan Ini: ${formattedTotal}</strong>`; } displayMessage(reportMessage, 'app'); }
        function deleteExpense(expenseId) { const initialLength = appData.expenses.length; appData.expenses = appData.expenses.filter(exp => exp.id !== expenseId); if (appData.expenses.length < initialLength) { saveAppData(); displayMessage(`Pengeluaran ID: <strong>${expenseId}</strong> berhasil dihapus.`, 'app'); } else { displayMessage(`Pengeluaran ID: <strong>${expenseId}</strong> tidak ditemukan.`, 'app'); } }
        function updateExpense(expenseId, newItem, newAmount) { const expenseIndex = appData.expenses.findIndex(exp => exp.id === expenseId); if (expenseIndex > -1) { appData.expenses[expenseIndex].item = newItem; appData.expenses[expenseIndex].amount = newAmount; appData.expenses[expenseIndex].timestamp = new Date(); saveAppData(); const formattedAmount = newAmount.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }); displayMessage(`Pengeluaran ID: <strong>${expenseId}</strong> diubah: <strong>${newItem}</strong> (${formattedAmount}).`, 'app'); } else { displayMessage(`Pengeluaran ID: <strong>${expenseId}</strong> tidak ditemukan.`, 'app'); } }
        async function processUserInput(input) { if (!input.trim()) return; displayMessage(input, 'user'); messageInput.value = ''; showLoader(true); const lowerInput = input.toLowerCase().trim(); const expenseRegex = /^(?!ubah|hapus|laporan)(.+?)\s+(\d+)$/i; const updateRegex = /^ubah\s+([\w-]+)\s+(.+?)\s+(\d+)$/i; const deleteRegex = /^hapus\s+([\w-]+)$/i; const expenseMatch = input.match(expenseRegex); const updateMatch = input.match(updateRegex); const deleteMatch = input.match(deleteRegex); try { if (updateMatch) { const [, id, newItem, newAmountStr] = updateMatch; updateExpense(id.trim(), newItem.trim(), parseInt(newAmountStr, 10)); } else if (deleteMatch) { const [, id] = deleteMatch; deleteExpense(id.trim()); } else if (expenseMatch) { const [, itemName, itemAmountStr] = expenseMatch; recordExpense(itemName.trim(), parseInt(itemAmountStr, 10)); } else if (lowerInput === 'laporan hari ini') { generateDailyReport(); } else if (lowerInput === 'laporan bulan ini') { generateMonthlyReport(); } else { displayMessage('Perintah tidak dikenali. Contoh:\n- "Kopi 5000"\n- "Laporan Hari Ini"\n- "ubah id item jumlah"\n- "hapus id"', 'app'); } } catch (error) { console.error("Error processing input:", error); displayMessage(`Terjadi kesalahan: ${error.message}. Coba lagi.`, 'app'); } finally { showLoader(false); } }

        // --- Event Listeners & Initialization ---
        sendButton.addEventListener('click', () => processUserInput(messageInput.value));
        messageInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') processUserInput(messageInput.value); });
        loadAppData();
        displayMessage('Selamat datang! Aplikasi siap digunakan. Data disimpan lokal. Ketik pengeluaran atau perintah. Gunakan menu (⋮) untuk fitur lain.', 'app');
    </script>
</body>
</html>

<!--
==========================================================================================
KONTEN UNTUK FILE `manifest.json` (SIMPAN SEBAGAI `manifest.json` DI DIREKTORI YANG SAMA):
==========================================================================================

==========================================================================================
KONTEN UNTUK FILE `sw.js` (SERVICE WORKER - SIMPAN SEBAGAI `sw.js` DI DIREKTORI YANG SAMA):
==========================================================================================

-->

